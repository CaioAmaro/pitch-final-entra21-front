<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Detalhes do Produto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .green-border {
        border: 1px solid #c7f1c7;
        border-radius: 5px;
        padding: 10px;
      }
      .product-img {
        max-width: 100%;
        height: auto;
        display: block;
        margin-left: auto;
        margin-right: auto;
      }
      .price-item {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }
      .price-item img {
        width: 40px;
        height: 40px;
        margin-right: 15px;
        border-radius: 5px;
        object-fit: contain;
      }
      .store-price h3 {
        font-weight: bold;
        margin: 0;
      }
      .store-price h5 {
        font-weight: normal;
        margin: 0;
      }
      .price-text {
        font-size: 2.5rem;
        font-weight: bold;
      }
      .best-price-badge {
        background-color: #d8f0d8;
        color: #1a6f3b;
        font-weight: bold;
        border-radius: 5px;
        padding: 5px 10px;
        white-space: nowrap;
      }
      .similar-product-card .card-img-top {
        height: 150px;
        object-fit: contain;
      }
      .similar-product-card .btn-custom-danger {
        background-color: #e66666;
        border-color: #e66666;
        color: white;
      }
      .placeholder-box {
        background-color: #d8f0d8;
        height: 150px;
      }
    </style>
  </head>
  <body>

    <div class="container my-5">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="#">Home</a></li>
          <li class="breadcrumb-item"><a href="catalogo-produtos.html">Produtos</a></li>
          <li class="breadcrumb-item"><a href="#" id="breadcrumb-category">Carregando...</a></li>
          <li class="breadcrumb-item active" aria-current="page" id="breadcrumb-product-name">Carregando...</li>
        </ol>
      </nav>

      <div class="row gx-5">
        <div class="col-md-6 mb-4 mb-md-0 d-flex justify-content-center align-items-center">
          <div id="main-product-image-container" class="green-border w-100 text-center">
            <div class="spinner-border text-primary" role="status"></div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="d-flex align-items-center mb-2">
            <h1 id="main-product-name">Carregando...</h1>
            <span id="savings-badge" class="badge text-bg-success ms-3" style="background-color: #1a6f3b !important; font-size: 0.9em; display: none;"></span>
          </div>
          <p id="main-product-description" class="text-muted">Carregando...</p>
          
          <div id="price-list-container" class="mt-4">
            <p>Carregando preços...</p>
          </div>
          <button class="btn btn-danger btn-lg mt-4" style="background-color: #d9534f; border-color: #d9534f;">Add na sua lista</button>
        </div>
      </div>

      <h2 class="mt-5 text-center" style="font-family: serif;">Similares</h2>
      <div id="similar-products-grid" class="row gx-5 mt-4">
        <div class="text-center">
          <div class="spinner-border text-primary" role="status"></div>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {

        const API_BASE_URL = 'http://localhost:8080';
        const urlParams = new URLSearchParams(window.location.search);
        const MAIN_PRODUCT_ID = urlParams.get('id');

        if (!MAIN_PRODUCT_ID) {
          document.querySelector('.row.gx-5').innerHTML = `<div class="alert alert-danger text-center">ID do produto não especificado na URL.</div>`;
          return;
        }

        const storeLogos = {
          'Koch': 'https://upload.wikimedia.org/wikipedia/commons/e/e0/Koch_Supermercados_-_Logo.png',
          'Angeloni': 'https://images.tcdn.com.br/img/img_prod/895315/1574519521_angeloni_logo.png',
          'Bistek': 'https://www.bistek.com.br/assets/images/logo_bistek.png',
          'Cooper': 'https://cooper.coop.br/media/imagens/logo.png',
          'Outros': 'https://placehold.co/40x40'
        };

        function getToken() {
          return localStorage.getItem('jwtToken');
        }

        async function fetchData(endpoint) {
          const token = getToken();
          if (!token) {
            console.error('Token JWT não encontrado. O login é necessário.');
            return null;
          }
          try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
              throw new Error(`Erro na requisição: ${response.statusText}`);
            }
            return await response.json();
          } catch (error) {
            console.error(`Falha ao buscar dados de ${endpoint}:`, error);
            return null;
          }
        }
        
        function formatPrice(price) {
          if (price === null || isNaN(price)) return 'N/A';
          return `R$${price.toFixed(2).replace('.', ',')}`;
        }

        /**
         * Renderiza a seção principal do produto.
         * @param {object} productData - Dados do produto de referência.
         * @param {Array<object>} scrapingData - Dados de preços coletados.
         */
        function renderMainProduct(productData, scrapingData) {
          const mainProductName = document.getElementById('main-product-name');
          const mainProductDescription = document.getElementById('main-product-description');
          const mainProductImageContainer = document.getElementById('main-product-image-container');
          const priceListContainer = document.getElementById('price-list-container');
          const breadcrumbCategory = document.getElementById('breadcrumb-category');
          const breadcrumbProductName = document.getElementById('breadcrumb-product-name');
          const savingsBadge = document.getElementById('savings-badge');

          mainProductImageContainer.innerHTML = '';
          priceListContainer.innerHTML = '';

          breadcrumbCategory.textContent = productData.marca || 'Categoria';
          breadcrumbProductName.textContent = productData.nome;

          if (productData.urlImg) {
            mainProductImageContainer.innerHTML = `<img src="${productData.urlImg}" class="product-img" alt="${productData.nome}">`;
          } else {
            mainProductImageContainer.innerHTML = `<div class="placeholder-box"></div>`;
          }

          mainProductName.textContent = productData.nome;
          mainProductDescription.textContent = productData.descricao || 'Produto sem descrição.';

          if (scrapingData && scrapingData.length > 0) {
            // Extrai todos os preços válidos
            const allPrices = scrapingData.map(item =>
              (item.precoEspecial !== null && item.precoEspecial > 0 && item.precoEspecial < item.preco) ? item.precoEspecial : item.preco
            ).filter(price => price !== null && !isNaN(price));
            
            if (allPrices.length >= 2) {
                const lowestPrice = Math.min(...allPrices);
                const highestPrice = Math.max(...allPrices);
                const savings = ((highestPrice - lowestPrice) / highestPrice) * 100;
                savingsBadge.textContent = `${savings.toFixed(0)}% de economia`;
                savingsBadge.style.display = 'inline-block';
            } else {
                savingsBadge.style.display = 'none';
            }

            // Ordena os dados de scraping para exibir o melhor preço primeiro
            scrapingData.sort((a, b) => {
              const priceA = (a.precoEspecial !== null && a.precoEspecial < a.preco) ? a.precoEspecial : a.preco;
              const priceB = (b.precoEspecial !== null && b.precoEspecial < b.preco) ? b.precoEspecial : b.preco;
              return priceA - priceB;
            });

            const bestPriceItem = scrapingData[0];
            const bestPrice = (bestPriceItem.precoEspecial !== null && bestPriceItem.precoEspecial < bestPriceItem.preco) ? bestPriceItem.precoEspecial : bestPriceItem.preco;
            const storeName = bestPriceItem.unidade.nome;
            const storeLogo = storeLogos[storeName] || storeLogos['Outros'];
            
            priceListContainer.innerHTML += `
              <div class="price-item">
                <img src="${storeLogo}" alt="${storeName} Logo">
                <div class="store-price">
                  <p class="mb-0">Melhor Preço</p>
                  <h3 class="price-text">${formatPrice(bestPrice)}</h3>
                </div>
              </div>
            `;

            scrapingData.slice(1).forEach(item => {
              const price = (item.precoEspecial !== null && item.precoEspecial < item.preco) ? item.precoEspecial : item.preco;
              const name = item.unidade.nome;
              const logo = storeLogos[name] || storeLogos['Outros'];

              priceListContainer.innerHTML += `
                <div class="price-item">
                  <img src="${logo}" alt="${name} Logo">
                  <div class="store-price">
                    <p class="mb-0">${name}</p>
                    <h5>${formatPrice(price)}</h5>
                  </div>
                </div>
              `;
            });
          } else {
            priceListContainer.innerHTML = `<p class="text-danger">Nenhum preço disponível.</p>`;
          }
        }

        async function renderSimilarProducts(products) {
          const similarProductsGrid = document.getElementById('similar-products-grid');
          similarProductsGrid.innerHTML = '';

          await Promise.all(products.map(async (product) => {
            const scrapingData = await fetchData(`/produtos/scraping/${product.id}?page=0&size=3`);
            
            let prices = [];
            if (scrapingData && scrapingData.content.length > 0) {
              prices = scrapingData.content.map(item => 
                (item.precoEspecial !== null && item.precoEspecial < item.preco) ? item.precoEspecial : item.preco
              );
              prices.sort((a, b) => a - b);
            }

            const cardHTML = `
              <div class="col-md-4 mb-4">
                <a href="detalhes-produto.html?id=${product.id}" class="text-decoration-none text-dark">
                  <div class="card similar-product-card h-100 green-border rounded-0">
                    <img src="${product.urlImg || 'https://placehold.co/150x150'}" class="card-img-top p-2" alt="${product.nome}">
                    <div class="card-body p-3">
                      <h6 class="card-title mb-1">${product.nome}</h6>
                      <small class="text-muted">Melhor preço</small>
                      <div class="d-flex gap-2 mt-2">
                        <span class="btn btn-sm btn-success rounded-1">${formatPrice(prices[0])}</span>
                        <span class="btn btn-sm btn-danger rounded-1" style="background-color: #e66666; border-color: #e66666;">${formatPrice(prices[1])}</span>
                        <span class="btn btn-sm btn-danger rounded-1" style="background-color: #e66666; border-color: #e66666;">${formatPrice(prices[2])}</span>
                      </div>
                    </div>
                  </div>
                </a>
              </div>
            `;
            similarProductsGrid.insertAdjacentHTML('beforeend', cardHTML);
          }));
        }

        async function loadProductPage() {
          const mainProductPromise = fetchData(`/produtos/referencias/${MAIN_PRODUCT_ID}`);
          const mainScrapingPromise = fetchData(`/produtos/scraping/${MAIN_PRODUCT_ID}?page=0`);
          const allReferencesPromise = fetchData('/produtos/referencias/listar?page=0&size=4');

          const [mainProduct, mainScraping, allReferences] = await Promise.all([
            mainProductPromise,
            mainScrapingPromise,
            allReferencesPromise
          ]);

          if (mainProduct) {
            renderMainProduct(mainProduct, mainScraping.content);
          } else {
            document.querySelector('.row.gx-5').innerHTML = `<div class="alert alert-danger text-center">Não foi possível carregar os detalhes do produto.</div>`;
          }

          if (allReferences) {
            const similarProducts = allReferences.content.filter(p => p.id !== parseInt(MAIN_PRODUCT_ID)).slice(0, 3);
            renderSimilarProducts(similarProducts);
          } else {
            document.getElementById('similar-products-grid').innerHTML = `<div class="alert alert-danger text-center">Não foi possível carregar produtos similares.</div>`;
          }
        }

        loadProductPage();
      });
    </script>
  </body>
</html>